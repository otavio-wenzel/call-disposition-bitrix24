<!DOCTYPE html>
<html lang="pt-BR">
  <head>
      <meta charset="UTF-8">
      <title>Classificação de Ligações</title>
      <script src="//api.bitrix24.com/api/v1/"></script>
      <style>
          body {
              font-family: Arial, sans-serif;
              margin: 0;
              background-color: #a5d2ff7e;
          }
          .header {
              background-color: #217bd4;
              color: white;
              padding: 16px 24px;
              font-size: 20px;
              font-weight: bold;
              text-align: center;
          }
          .container {
              max-width: 760px;
              margin: 16px auto;
              padding: 0 16px 16px;
              box-sizing: border-box;
          }
          .card {
              background-color: #ffffff;
              border-radius: 4px;
              padding: 16px 18px;
              margin-bottom: 16px;
              box-shadow: 0 1px 3px rgba(0,0,0,0.08);
          }
          .card h3 {
              margin-top: 0;
          }
          .row {
              margin: 8px 0;
          }

          button {
              background-color: #27ae60;
              color: white;
              border: none;
              padding: 6px 14px;
              border-radius: 3px;
              cursor: pointer;
              font-size: 13px;
          }
          button[disabled] {
              background-color: #95a5a6;
              cursor: default;
          }
          .btn-small {
              padding: 4px 10px;
              font-size: 12px;
          }
          select {
              padding: 6px 10px;
              font-size: 13px;
              min-width: 220px;
          }
          small {
              color: #777;
              font-size: 11px;
          }
          #admin-block {
              border-top: 2px solid #eee;
              margin-top: 8px;
              padding-top: 8px;
          }
          textarea {
              width: 100%;
              height: 120px;
              font-size: 11px;
              font-family: Consolas, monospace;
              box-sizing: border-box;
          }

          table {
              width: 100%;
              border-collapse: collapse;
              font-size: 12px;
          }
          th, td {
              padding: 4px 6px;
              border-bottom: 1px solid #eee;
              text-align: left;
          }
          th {
              background-color: #f5f7f9;
              font-weight: 600;
          }
          td.col-contato,
          td.col-numero,
          td.col-data,
          td.col-dur {
              white-space: nowrap;
          }
          td.col-status {
              white-space: normal;
              word-break: break-word;
              max-width: 200px;
          }
          tbody tr:hover {
              background-color: #f3f9ff;
              cursor: pointer;
          }
          .text-center {
              text-align: center;
          }
          .table-wrapper {
              overflow-x: auto;
          }

          /* ====== ESTILO ESPECÍFICO DA DIV DA LIGAÇÃO ATUAL ====== */
          .current-call-main {
              text-align: center;
          }
          .current-call-contact {
              font-size: 16px;
              font-weight: 600;
              margin-top: 4px;
              margin-bottom: 8px;
          }
          .current-call-main label {
              font-weight: 600;
          }
          .current-call-note {
              margin-top: 6px;
              text-align: left;
          }
      </style>
  </head>
  <body>
    <div class="header" id="app-header">
        Classificação de Ligações
    </div>

    <div class="container">

        <!-- Bloco de administração (registro do background worker) -->
        <div class="card" id="admin-block">
            <h3>Background worker (Admin)</h3>
            <div class="row">
                <small>
                    Este botão registra o background worker (<b>PAGE_BACKGROUND_WORKER</b>),
                    que fica observando as ligações concluídas e abre esta tela automaticamente
                    após cada chamada.
                </small>
            </div>
            <div class="row">
                <button id="btn-register-bg">Registrar / atualizar BACKGROUND WORKER</button>
                <span id="bg-status" style="margin-left:10px;font-size:12px;color:#555;"></span>
            </div>
        </div>

        <!-- Bloco principal: última ligação + classificação -->
        <div class="card">
            <div class="current-call-main">
                <h4 id="current-call-title">Última ligação concluída:</h4>
                <div id="last-call-text" class="row current-call-contact">carregando...</div>
                <div class="row">
                    <button id="btn-refresh-last">Atualizar última ligação</button>
                </div>
                <hr>
                <div class="row">
                    <label for="call-result" class="center-label">Resultado da chamada:</label><br>
                    <select id="call-result">
                        <option value="">-- selecione --</option>
                        <option value="REUNIÃO AGENDADA">REUNIÃO AGENDADA</option>
                        <option value="FALEI COM SECRETÁRIA">FALEI COM SECRETÁRIA</option>
                        <option value="FOLLOW-UP">FOLLOW-UP</option>
                        <option value="RETORNO POR E-MAIL">RETORNO POR E-MAIL</option>
                        <option value="NÃO TEM INTERESSE">NÃO TEM INTERESSE</option>
                        <option value="NÃO FAZ LOCAÇÃO">NÃO FAZ LOCAÇÃO</option>
                        <option value="CAIXA POSTAL">CAIXA POSTAL</option>
                    </select>
                </div>
                <div class="row">
                    <button id="btn-save-result">Salvar resultado desta ligação</button>
                </div>
            </div>
            <div class="row current-call-note">
                <small>
                    OBS: a classificação é aplicada sempre na última atividade de ligação
                    concluída do usuário logado, ou na ligação que você
                    selecionar na lista abaixo.
                </small>
            </div>
        </div>

        <!-- Log (apenas admin) -->
        <div class="card" id="log-card">
            <h3>Log</h3>
            <textarea id="log" readonly></textarea>
        </div>

        <!-- Histórico de ligações -->
        <div class="card">
            <h3>Histórico recente de ligações</h3>
            <div class="row table-wrapper">
                <table id="calls-table">
                    <thead>
                    <tr>
                        <th>Contato</th>
                        <th>Número</th>
                        <th>Data</th>
                        <th>Duração (mm:ss)</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="row text-center">
                <button type="button" id="btn-prev-page" class="btn-small">&lt;</button>
                <span id="page-indicator" style="margin:0 10px;">0 / 0</span>
                <button type="button" id="btn-next-page" class="btn-small">&gt;</button>
            </div>
        </div>

    </div>

    <script>
    (function() {
        const logEl              = document.getElementById('log');
        const logCardEl          = document.getElementById('log-card');
        const appHeaderEl        = document.getElementById('app-header');
        const adminBlockEl       = document.getElementById('admin-block');

        const lastCallTextEl     = document.getElementById('last-call-text');
        const currentCallTitleEl = document.getElementById('current-call-title');
        const btnRefreshLast     = document.getElementById('btn-refresh-last');
        const btnSaveResult      = document.getElementById('btn-save-result');
        const selectResult       = document.getElementById('call-result');
        const btnRegisterBg      = document.getElementById('btn-register-bg');
        const callsTableBody     = document.querySelector('#calls-table tbody');
        const btnPrevPage        = document.getElementById('btn-prev-page');
        const btnNextPage        = document.getElementById('btn-next-page');
        const pageIndicator      = document.getElementById('page-indicator');

        const TITLE_LAST     = 'Última ligação concluída:';
        const TITLE_SELECTED = 'Ligação selecionada:';

        let CURRENT_USER_ID = null;
        let IS_ADMIN = false;

        let ACTIVITIES = [];       // até 50 últimas ligações
        let LAST_ACTIVITY = null;  // ligação atualmente exibida
        let LAST_SELECTED_FROM_LIST = false;
        const PAGE_SIZE = 10;
        let currentPage = 0;

        // evita múltiplas buscas simultâneas
        let isLoadingActivities = false;
        let loadTimeoutId = null;

        // ---------- LOG LEVE ----------
        function log(msg, data) {
            if (!logEl) {
                console.log('[NOLOG]', msg, data || '');
                return;
            }
            const now = new Date();
            const hh = String(now.getHours()).padStart(2,'0');
            const mm = String(now.getMinutes()).padStart(2,'0');
            const ss = String(now.getSeconds()).padStart(2,'0');
            let line = `[${hh}:${mm}:${ss}] ${msg}`;

            if (data !== undefined) {
                try {
                    if (Array.isArray(data)) {
                        line += ` [Array length=${data.length}]`;
                    } else if (typeof data === 'object') {
                        line += ' ' + JSON.stringify(data);
                    } else {
                        line += ' ' + String(data);
                    }
                } catch(e) {
                    line += ' ' + String(data);
                }
            }
            logEl.value += line + "\n";
            logEl.scrollTop = logEl.scrollHeight;
            console.log(line);
        }

        // erros globais de JS também vão para o log
        window.addEventListener('error', function (ev) {
            const msg = ev.message || (ev.error && ev.error.message) || ev.error || '';
            log('JS ERROR GLOBAL', msg);
        });

        // ---------- URL BASE / HANDLERS ----------
        function getBaseUrl() {
            const full = window.location.href.split('#')[0];
            const withoutQuery = full.split('?')[0];
            const idx = withoutQuery.lastIndexOf('/');
            return withoutQuery.substring(0, idx + 1);
        }

        const BASE_URL    = getBaseUrl();
        const handlerUrl  = BASE_URL + 'index.html';
        const bgHandlerUrl= BASE_URL + 'background.html';

        log('[INIT] BASE_URL = ' + BASE_URL);
        log('[INIT] handlerUrl = ' + handlerUrl);
        log('[INIT] bgHandlerUrl = ' + bgHandlerUrl);

        // ---------- HELPERS ----------
        function extractPhoneFromSubject(subject) {
            if (!subject) return '';
            const match = subject.match(/(\+?\d[\d\s\-\(\)]*\d)/);
            return match ? match[1].trim() : '';
        }

        function formatDurationMmSs(startIso, endIso) {
            if (!startIso || !endIso) return '-';
            const start = new Date(startIso);
            const end   = new Date(endIso);
            const diffMs = end - start;
            if (!isFinite(diffMs) || diffMs <= 0) return '-';
            const totalSeconds = Math.floor(diffMs / 1000);
            const mm = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const ss = String(totalSeconds % 60).padStart(2, '0');
            return mm + ':' + ss;
        }

        function resolveContactAndPhone(a) {
            let nomeContato = 'Contato não salvo';
            let telefone = '';

            if (Array.isArray(a.COMMUNICATIONS) && a.COMMUNICATIONS.length > 0) {
                const comm = a.COMMUNICATIONS[0];
                telefone = comm.VALUE || '';

                const hasEntity =
                    comm.ENTITY_ID &&
                    String(comm.ENTITY_ID) !== '0' &&
                    String(comm.ENTITY_ID).trim() !== '';

                if (hasEntity) {
                    if (comm.ENTITY_SETTINGS && typeof comm.ENTITY_SETTINGS === 'object') {
                        const es = comm.ENTITY_SETTINGS;
                        const parts = [];
                        if (es.HONORIFIC)   parts.push(es.HONORIFIC);
                        if (es.NAME)        parts.push(es.NAME);
                        if (es.SECOND_NAME) parts.push(es.SECOND_NAME);
                        if (es.LAST_NAME)   parts.push(es.LAST_NAME);
                        const fromSettings = parts.join(' ').trim();
                        if (fromSettings) {
                            nomeContato = fromSettings;
                        }
                    }

                    if (nomeContato === 'Contato não salvo') {
                        nomeContato =
                            comm.ENTITY_NAME ||
                            comm.TITLE ||
                            comm.NAME ||
                            nomeContato;
                    }
                }
            }

            if (!telefone) {
                telefone = extractPhoneFromSubject(a.SUBJECT || '');
            }
            if (!telefone && a.SUBJECT) {
                telefone = a.SUBJECT;
            }

            return { contactName: nomeContato, phone: telefone };
        }

        function applyStatusFromDescription(activity) {
            if (!activity) {
                selectResult.value = '';
                return;
            }
            const desc = (activity.DESCRIPTION || '').trim();
            if (!desc) {
                selectResult.value = '';
                return;
            }

            let chosen = '';
            const opts = Array.from(selectResult.options).map(o => o.value);

            for (const v of opts) {
                if (!v) continue;
                if (desc === v) {
                    chosen = v;
                    break;
                }
            }
            if (!chosen) {
                for (const v of opts) {
                    if (!v) continue;
                    if (desc.toUpperCase().includes(v.toUpperCase())) {
                        chosen = v;
                        break;
                    }
                }
            }
            selectResult.value = chosen;
        }

        function setCurrentActivity(activity, isSelectedFromList) {
            try {
                log('setCurrentActivity chamado', {
                    hasActivity: !!activity,
                    fromList: !!isSelectedFromList
                });

                LAST_ACTIVITY = activity || null;
                LAST_SELECTED_FROM_LIST = !!isSelectedFromList;

                if (!LAST_ACTIVITY) {
                    lastCallTextEl.textContent =
                        'Nenhuma chamada concluída encontrada para este usuário.';
                    selectResult.value = '';
                    currentCallTitleEl.textContent = TITLE_LAST;
                    return;
                }

                const info = resolveContactAndPhone(LAST_ACTIVITY);
                lastCallTextEl.textContent = `${info.contactName} | ${info.phone}`;

                applyStatusFromDescription(LAST_ACTIVITY);
                currentCallTitleEl.textContent =
                    isSelectedFromList ? TITLE_SELECTED : TITLE_LAST;
            } catch (e) {
                log('ERRO em setCurrentActivity', e && e.message ? e.message : e);
            }
        }

        // ---------- TABELA / PAGINAÇÃO ----------
        function renderActivitiesTable() {
            callsTableBody.innerHTML = '';

            const total = ACTIVITIES.length;
            log('renderActivitiesTable: total atividades = ' + total);

            if (!total) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 5;
                td.textContent = 'Nenhuma chamada encontrada.';
                tr.appendChild(td);
                callsTableBody.appendChild(tr);
                pageIndicator.textContent = '0 / 0';
                btnPrevPage.disabled = true;
                btnNextPage.disabled = true;
                return;
            }

            const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
            if (currentPage >= totalPages) currentPage = totalPages - 1;

            const start = currentPage * PAGE_SIZE;
            const end   = Math.min(start + PAGE_SIZE, total);

            for (let i = start; i < end; i++) {
                const a = ACTIVITIES[i];
                const tr = document.createElement('tr');
                tr.dataset.index = String(i);

                const { contactName, phone } = resolveContactAndPhone(a);
                const dateStr = a.END_TIME
                    ? new Date(a.END_TIME).toLocaleString('pt-BR')
                    : '-';
                const durStr = formatDurationMmSs(a.START_TIME, a.END_TIME);
                const statusStr = (a.DESCRIPTION || '').trim() || '-';

                const tdContato = document.createElement('td');
                tdContato.textContent = contactName;
                tdContato.className = 'col-contato';

                const tdNumero = document.createElement('td');
                tdNumero.textContent = phone;
                tdNumero.className = 'col-numero';

                const tdData = document.createElement('td');
                tdData.textContent = dateStr;
                tdData.className = 'col-data';

                const tdDur = document.createElement('td');
                tdDur.textContent = durStr;
                tdDur.className = 'col-dur';

                const tdStatus = document.createElement('td');
                tdStatus.textContent = statusStr;
                tdStatus.className = 'col-status';

                tr.appendChild(tdContato);
                tr.appendChild(tdNumero);
                tr.appendChild(tdData);
                tr.appendChild(tdDur);
                tr.appendChild(tdStatus);

                tr.addEventListener('click', function () {
                    const idx = parseInt(this.dataset.index, 10);
                    const act = ACTIVITIES[idx];
                    setCurrentActivity(act, true);
                });

                callsTableBody.appendChild(tr);
            }

            const totalPages2 = Math.max(1, Math.ceil(total / PAGE_SIZE));
            pageIndicator.textContent = (currentPage + 1) + ' / ' + totalPages2;
            btnPrevPage.disabled = currentPage <= 0;
            btnNextPage.disabled = currentPage >= totalPages2 - 1;
        }

        // ---------- CARREGAR ÚLTIMAS LIGAÇÕES ----------
        function loadLastCall() {
            if (!CURRENT_USER_ID) {
                log('loadLastCall chamado sem CURRENT_USER_ID.');
                return;
            }

            if (isLoadingActivities) {
                log('loadLastCall ignorado: já existe requisição em andamento.');
                return;
            }

            isLoadingActivities = true;
            lastCallTextEl.textContent = 'carregando...';
            btnRefreshLast.disabled = true;

            // timeout de segurança: se o Bitrix não responder, não fica travado
            if (loadTimeoutId) {
                clearTimeout(loadTimeoutId);
                loadTimeoutId = null;
            }
            loadTimeoutId = setTimeout(function () {
                if (!isLoadingActivities) return;
                log('TIMEOUT: crm.activity.list não respondeu em 10s.');
                isLoadingActivities = false;
                btnRefreshLast.disabled = false;
                setCurrentActivity(null, false);
                renderActivitiesTable();
            }, 10000);

            log('Buscando últimas CALLs concluídas. USER_ID = ' + CURRENT_USER_ID + ' ...');
            BX24.callMethod(
                'crm.activity.list',
                {
                    order: { "END_TIME": "DESC" },
                    filter: {
                        "TYPE_ID": 2,
                        "COMPLETED": "Y",
                        "RESPONSIBLE_ID": CURRENT_USER_ID
                    },
                    select: [
                        "ID", "SUBJECT", "START_TIME", "END_TIME",
                        "RESPONSIBLE_ID", "DESCRIPTION", "COMMUNICATIONS"
                    ]
                },
                function(result) {
                    // callback SEMPRE protegido
                    try {
                        if (loadTimeoutId) {
                            clearTimeout(loadTimeoutId);
                            loadTimeoutId = null;
                        }

                        isLoadingActivities = false;
                        btnRefreshLast.disabled = false;

                        if (!result) {
                            log('crm.activity.list retornou result vazio/undefined');
                            setCurrentActivity(null, false);
                            renderActivitiesTable();
                            return;
                        }

                        if (typeof result.error !== 'function') {
                            log('crm.activity.list: result.error não é função', result);
                        }

                        if (typeof result.error === 'function' && result.error()) {
                            log('crm.activity.list ERRO', result.error());
                            setCurrentActivity(null, false);
                            renderActivitiesTable();
                            return;
                        }

                        const data = (typeof result.data === 'function')
                            ? (result.data() || [])
                            : [];

                        log('crm.activity.list SUCESSO. qtd=' + data.length);

                        ACTIVITIES = data;
                        currentPage = 0;

                        if (ACTIVITIES.length > 0) {
                            setCurrentActivity(ACTIVITIES[0], false);
                        } else {
                            setCurrentActivity(null, false);
                        }

                        renderActivitiesTable();
                    } catch (e) {
                        log('EXCEPTION no callback crm.activity.list',
                            e && e.message ? e.message : e);
                        setCurrentActivity(null, false);
                        renderActivitiesTable();
                    }
                }
            );
        }

        // ---------- SALVAR RESULTADO ----------
        function saveCallResult() {
            if (!LAST_ACTIVITY) {
                alert('Nenhuma ligação encontrada para classificar.');
                return;
            }
            const val = selectResult.value;
            if (!val) {
                alert('Selecione um resultado para a chamada.');
                return;
            }

            const newDescription = val;

            log('Atualizando crm.activity.update ID=' + LAST_ACTIVITY.ID + ' ...');
            BX24.callMethod(
                'crm.activity.update',
                {
                    id: LAST_ACTIVITY.ID,
                    fields: {
                        DESCRIPTION: newDescription
                    }
                },
                function(result) {
                    if (result.error && result.error()) {
                        log('crm.activity.update ERRO', result.error());
                        alert('Erro ao salvar resultado. Veja o log.');
                        return;
                    }
                    log('crm.activity.update SUCESSO');
                    alert('Resultado salvo com sucesso.');
                    loadLastCall();
                }
            );
        }

        // ---------- REGISTRO DO BACKGROUND WORKER ----------
        function registerBackgroundWorker() {
            if (!IS_ADMIN) {
                log('[ADMIN] Tentativa de registrar PAGE_BACKGROUND_WORKER por usuário não admin. Operação bloqueada.');
                alert('Você não tem permissão para registrar o background worker.');
                return;
            }

            log("[ADMIN] Iniciando registro do PAGE_BACKGROUND_WORKER...");

            const placementOptions = {
                ERROR_HANDLER_URL: handlerUrl,
                errorHandlerUrl: handlerUrl
            };
            log("[ADMIN] placementOptions", placementOptions);

            BX24.callMethod(
                "placement.unbind",
                { PLACEMENT: "PAGE_BACKGROUND_WORKER" },
                function (resUnbind) {
                    if (resUnbind.error && resUnbind.error()) {
                        log("[ADMIN] placement.unbind PAGE_BACKGROUND_WORKER ERRO", resUnbind.error());
                    } else {
                        log("[ADMIN] placement.unbind PAGE_BACKGROUND_WORKER SUCESSO");
                    }

                    log("[ADMIN] Chamando placement.bind PAGE_BACKGROUND_WORKER...");
                    log("[ADMIN] handlerUrl = " + handlerUrl);
                    log("[ADMIN] bgHandlerUrl = " + bgHandlerUrl);

                    BX24.callMethod(
                        "placement.bind",
                        {
                            PLACEMENT: "PAGE_BACKGROUND_WORKER",
                            HANDLER: bgHandlerUrl,
                            TITLE: "Watcher de ligações (SDR)",
                            DESCRIPTION: "Observa ligações concluídas e abre a tela de classificação.",
                            OPTIONS: placementOptions
                        },
                        function (resBind) {
                            if (resBind.error && resBind.error()) {
                                const err = resBind.error();
                                log("[ADMIN] placement.bind PAGE_BACKGROUND_WORKER ERRO", err);
                                alert("Erro ao registrar background worker:\n"
                                    + JSON.stringify(err));
                            } else {
                                log("[ADMIN] placement.bind PAGE_BACKGROUND_WORKER SUCESSO");
                                alert("Background worker registrado com sucesso.");
                            }
                        }
                    );
                }
            );
        }

        // ---------- INICIALIZAÇÃO BITRIX24 ----------
        BX24.init(function() {
            log('BX24.init OK. Pronto para usar API.');
            BX24.callMethod('user.current', {}, function(res) {
                if (res.error && res.error()) {
                    log('user.current ERRO', res.error());
                    return;
                }
                const user = res.data();
                CURRENT_USER_ID = parseInt(user.ID, 10);
                log('user.current SUCESSO, ID=' + CURRENT_USER_ID, {
                    ID: user.ID,
                    NAME: user.NAME,
                    LAST_NAME: user.LAST_NAME,
                    UF_PHONE_INNER: user.UF_PHONE_INNER
                });

                try {
                    if (typeof BX24.isAdmin === 'function') {
                        IS_ADMIN = !!BX24.isAdmin();
                    } else if (user && (user.ADMIN === true || user.IS_ADMIN === 'Y')) {
                        IS_ADMIN = true;
                    } else {
                        IS_ADMIN = false;
                    }
                } catch (e) {
                    IS_ADMIN = false;
                }
                log('IS_ADMIN = ' + IS_ADMIN);

                if (appHeaderEl) {
                    const nome = user.NAME || '';
                    const sobrenome = user.LAST_NAME || '';
                    const fullName = (nome + ' ' + sobrenome).trim();
                    appHeaderEl.textContent =
                        'Classificação de Ligações' +
                        (fullName ? ' - ' + fullName : '');
                }

                if (!IS_ADMIN) {
                    if (adminBlockEl) adminBlockEl.style.display = 'none';
                    if (logCardEl)    logCardEl.style.display   = 'none';
                    log('Blocos de administração e log ocultos para usuário não admin.');
                } else {
                    log('Blocos de administração e log visíveis (usuário admin).');
                }

                loadLastCall();
            });
        });

        // ---------- EVENTOS DE UI ----------
        btnRefreshLast.addEventListener('click', loadLastCall);
        btnSaveResult.addEventListener('click', saveCallResult);
        btnRegisterBg.addEventListener('click', registerBackgroundWorker);

        btnPrevPage.addEventListener('click', function () {
            if (currentPage > 0) {
                currentPage--;
                renderActivitiesTable();
            }
        });
        btnNextPage.addEventListener('click', function () {
            const totalPages = Math.max(1, Math.ceil(ACTIVITIES.length / PAGE_SIZE));
            if (currentPage < totalPages - 1) {
                currentPage++;
                renderActivitiesTable();
            }
        });

    })();
    </script>
  </body>
</html>