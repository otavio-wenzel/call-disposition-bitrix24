<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SDR Call Watcher (Background)</title>
    <script src="//api.bitrix24.com/api/v1/"></script>
</head>
<body>
<script>
(function() {
    let CURRENT_USER_ID = null;
    let lastActivityId = null;
    let pollTimer = null;

    function log(msg, data) {
        // Só para debug no console; esse HTML nunca aparece visualmente
        const now = new Date();
        const hh = String(now.getHours()).padStart(2,'0');
        const mm = String(now.getMinutes()).padStart(2,'0');
        const ss = String(now.getSeconds()).padStart(2,'0');
        let line = `[BG ${hh}:${mm}:${ss}] ${msg}`;
        if (data !== undefined) {
            try {
                line += ' ' + JSON.stringify(data);
            } catch(e) {
                line += ' ' + String(data);
            }
        }
        console.log(line);
    }

    function pollLastCall() {
        if (!CURRENT_USER_ID) {
            log('pollLastCall chamado sem CURRENT_USER_ID.');
            return;
        }

        log('Background: consultando crm.activity.list para última CALL concluída...');

        BX24.callMethod(
            'crm.activity.list',
            {
                order: { "END_TIME": "DESC" },
                filter: {
                    "TYPE_ID": 2,
                    "COMPLETED": "Y",
                    "RESPONSIBLE_ID": CURRENT_USER_ID
                },
                select: [ "ID", "END_TIME", "SUBJECT", "RESPONSIBLE_ID" ]
            },
            function(result) {
                if (result.error()) {
                    log('crm.activity.list (BG) ERRO', result.error());
                    return;
                }
                const data = result.data();
                if (!data || !data.length) {
                    log('crm.activity.list (BG) sem resultados.');
                    return;
                }

                const latest = data[0];
                const latestId = parseInt(latest.ID, 10);

                if (lastActivityId === null) {
                    // primeira vez: só marque e não faz nada
                    lastActivityId = latestId;
                    log('BG inicializou lastActivityId=' + lastActivityId);
                    return;
                }

                if (latestId !== lastActivityId) {
                    // Encontramos uma nova ligação concluída
                    log('BG detectou nova ligação concluída ID=' + latestId +
                        ' (antes era ' + lastActivityId + '). Abrindo aplicação...');

                    lastActivityId = latestId;

                    // Tenta abrir o app de classificação em um slider / aba
                    // Essa função deve funcionar tanto no navegador quanto no app desktop.
                    try {
                        BX24.openApplication(); // abre este app
                    } catch(e) {
                        log('Erro ao chamar BX24.openApplication', String(e));
                    }
                }
            }
        );
    }

    BX24.init(function() {
        log('Background worker carregado, iniciando BX24.init...');
        BX24.callMethod('user.current', {}, function(res) {
            if (res.error()) {
                log('user.current (BG) ERRO', res.error());
                return;
            }
            const user = res.data();
            CURRENT_USER_ID = parseInt(user.ID, 10);
            log('user.current (BG) SUCESSO. USER_ID=' + CURRENT_USER_ID, user);

            // primeira leitura imediata
            pollLastCall();
            // depois, repete a cada 10 segundos (ajuste se quiser mais/menos agressivo)
            pollTimer = setInterval(pollLastCall, 3000);
        });
    });
})();
</script>
</body>
</html>